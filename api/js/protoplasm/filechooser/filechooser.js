if(window.Control==undefined){Control={}}Control.FileChooser=Class.create();Control.FileChooser.prototype={initialize:function(b,c,a){this.element=$(b);if(fc=this.element.retrieve("filechooser")){fc.destroy()}this.options=a||{};if(window.Protoplasm!=undefined){var d=Protoplasm.base("filechooser");if(d){if(!this.options.icon){this.options.icon=d+"filechooser.png"}if(!this.options.fileImage){this.options.fileImage=d+"file.gif"}if(!this.options.directoryImage){this.options.directoryImage=d+"directory.gif"}if(!this.options.parentImage){this.options.parentImage=d+"parent.gif"}Protoplasm.loadStylesheet("filechooser.css","filechooser")}}if(this.options.icon){this.element.style.background="url("+this.options.icon+") right center no-repeat #FFF";this.oldPadding=this.element.style.paddingRight;this.element.style.paddingRight="20px"}this.filechooser=new Control.FileChooserPanel(c,Object.extend({openListener:this.fileSelected.bind(this),standalone:true,selectFile:this.element.value},this.options||{}));this.dialogOpen=false;this.dialog=this.filechooser.getElement();this.listeners=[this.element.on("click",this.toggleChooser.bindAsEventListener(this)),this.element.on("blur",this.delayedHide.bindAsEventListener(this)),this.dialog.on("click",this.cancelHide.bindAsEventListener(this)),this.element.on("keydown",this.hideChooser.bindAsEventListener(this))];this.clickListener=null;this.element.store("filechooser",this);this.destructor=Event.on(window,"unload",this.destroy.bind(this))},destroy:function(){this.hideChooser();for(var a=0;a<this.listeners.length;a++){this.listeners[a].stop()}if(this.clickListener){this.clickListener.stop()}this.element.style.paddingRight=this.oldPadding;this.element.store("filechooser",null);this.destructor.stop()},fileSelected:function(a){this.element.value=a.url;this.hideChooser()},toggleChooser:function(){if(this.dialogOpen){this.hideChooser()}else{this.showChooser()}},showChooser:function(){if(!this.dialogOpen){var c=Element.getDimensions(this.element);var a=Position.cumulativeOffset(this.element);var b=/MSIE/.test(navigator.userAgent)?(a[1]+c.height)+"px":(a[1]+c.height-1)+"px";this.dialog.style.top=b;this.dialog.style.left=a[0]+"px";if(this.element.value){this.filechooser.select(this.element.value)}else{this.filechooser.refresh()}document.body.appendChild(this.dialog);this.clickListener=document.on("click",this.documentClickHandler.bindAsEventListener(this));this.dialogOpen=true}},delayedHide:function(a){this.hideTimeout=setTimeout(this.hideChooser,100)},cancelHide:function(a){if(this.hideTimeout){clearTimeout(this.hideTimeout);this.hideTimeout=null}},hideChooser:function(){if(this.dialogOpen){if(this.clickListener){this.clickListener.stop();this.clickListener=null}if(this.dialog.parentNode){Element.remove(this.dialog)}this.dialogOpen=false}},documentClickHandler:function(b){var a=Event.element(b);var c=false;do{if(a==this.dialog||a==this.element){c=true}}while(a=a.parentNode);if(!c){this.hideChooser()}}};Control.FileChooserPanel=Class.create();Control.FileChooserPanel.prototype={initialize:function(a,b){this.fileLister=a||Prototype.emptyFunction;this.options=Object.extend({width:360,height:220,className:"filechooserControl",fileImage:"/images/icons/file.gif",directoryImage:"/images/icons/directory.gif",parentImage:"/images/icons/parent.gif",uploadHandler:this.showUploadDialog.bindAsEventListener(this)},b||{});this.element=this.createFileChooser();if(this.options.selectFile){this.select(this.options.selectFile)}},getElement:function(){return this.element},createFileChooser:function(){var e=document.createElement("div");this.directoryHeader=document.createElement("div");this.directoryHeader.style.marginBottom="5px";this.directoryHeader.className="directoryheader";this.directoryHeader.innerHTML="&nbsp;";e.appendChild(this.directoryHeader);var k=document.createElement("table");k.cellSpacing=0;k.cellPadding=0;k.style.border=0;var l=k.insertRow(0);var f=this.options.height-40;var c=Math.round((this.options.width-6)*0.3);var d=this.options.height-61;var i=this.options.width-c-10;var j=l.insertCell(0);j.vAlign="top";this.fileList=document.createElement("div");Element.setStyle(this.fileList,{height:d+"px",width:i+"px",overflow:"auto",marginRight:"3px",marginBottom:"5px"});this.fileList.className="filelist";this.fileList.onmousedown=function(){return false};this.fileList.onselectstart=function(){return false};j.appendChild(this.fileList);this.createButton=document.createElement("input");this.createButton.type="button";this.createButton.value="New Folder";this.createButton.style.marginRight="5px";this.createButton.style.width=Math.round((i-10)/3)+"px";this.createButton.onclick=this.showDirectoryCreateDialog.bindAsEventListener(this);this.uploadButton=document.createElement("input");this.uploadButton.type="button";this.uploadButton.value="New File";this.uploadButton.style.marginRight="5px";this.uploadButton.style.width=Math.round((i-10)/3)+"px";this.uploadButton.onclick=function(m){this.options.uploadHandler(this)}.bindAsEventListener(this);this.deleteButton=document.createElement("input");this.deleteButton.type="button";this.deleteButton.value="Delete";this.deleteButton.style.width=Math.round((i-10)/3)+"px";this.deleteButton.onclick=this.showDeleteDialog.bindAsEventListener(this);var g=document.createElement("div");g.appendChild(this.createButton);g.appendChild(this.uploadButton);g.appendChild(this.deleteButton);j.appendChild(g);j=l.insertCell(1);j.vAlign="top";this.filePreview=document.createElement("div");Element.setStyle(this.filePreview,{height:f+"px",width:c+"px",marginLeft:"3px",marginBottom:"5px",overflow:"hidden",position:"relative"});this.filePreview.className="filepreview";j.appendChild(this.filePreview);e.appendChild(k);Event.observe(document,"keypress",this.keyPressListener());if(this.options.standalone){var b=document.createElement("form");b.style.margin=0;var k=document.createElement("table");k.cellSpacing=0;k.cellPadding=0;k.border=0;var l=k.insertRow(0);var j=l.insertCell(0);this.fileLocation=document.createElement("input");this.fileLocation.type="text";this.fileLocation.style.width="245px";this.fileLocation.style.marginRight="5px";this.fileLocation.readOnly=true;j.appendChild(this.fileLocation);j=l.insertCell(1);j.style.textAlign="right";var h=document.createElement("input");h.type="button";h.value="Cancel";h.style.width="50px";h.style.marginRight="5px";h.onclick=function(m){Element.remove(this.getElement())}.bindAsEventListener(this);j.appendChild(h);j=l.insertCell(2);j.style.textAlign="right";var h=document.createElement("input");h.type="button";h.value="Select";h.style.width="50px";h.onclick=function(m){(this.options.openListener||Prototype.emptyFunction)(this.selectedFile)}.bindAsEventListener(this);j.appendChild(h);b.appendChild(k);e.appendChild(b);var a=document.createElement("div");a.style.position="absolute";a.appendChild(e);a.className=this.options.className;return a}else{e.className=this.options.className;return e}},select:function(b){this.filePreview.innerHTML="";this.fileList.innerHTML='<div style="padding:3px">Loading file list...</div>';this.selectedFile=null;var a=this.fileLister(null,this.selectByURL(b).bind(this));if(a){this.selectByURL(b)(a)}},selectByURL:function(a){return function(b){if(b.status!="error"&&a&&a.indexOf(b.url)==0){var d=a.substr(b.url.length);var c=d.substr(0,d.lastIndexOf("/"));this.pendingSelect=a;if(c!=b.path){this.refresh(c);return}}this.populateFileList(b)}.bind(this)},refresh:function(a){if(!a&&this.currentDirectory){a=this.currentDirectory.path}if(this.prompt&&this.prompt.parentNode){Element.remove(this.prompt)}this.filePreview.innerHTML="";this.fileList.innerHTML='<div style="padding:3px">Loading file list...</div>';this.selectedFile=null;var b=this.fileLister(a,this.populateFileList.bind(this));if(b){this.populateFileList(b)}},populateFileList:function(b){if(b.status=="error"){this.refresh();return}this.currentDirectory=b;this.entries=[];this.directoryHeader.innerHTML="<b>Folder:</b> "+(b.path||"/");this.fileList.innerHTML="";if(b.parent){this.entries[this.entries.length]={image:"parent",type:"directory",name:"Parent folder",path:b.parent}}if(b.files){if(b.files.constructor==Array){b.files.each(function(i){this.entries.push(i)}.bind(this))}else{this.entries.push(b.files)}}if(this.entries.length){var g=document.createElement("table");var a=null;g.cellSpacing=0;g.cellPadding=0;g.width="100%";g.style.border=3;this.entries.each(function(j){var i=this.createFileRow(j,g);if(this.pendingSelect&&this.pendingSelect==j.url){this.selectRow(j);a=i;this.pendingSelect=null}}.bind(this));this.fileList.appendChild(g);if(a){var f=g.offsetHeight;var c=this.fileList.offsetHeight;var d=a.offsetTop;var e=d+a.offsetHeight;if(e>c){var h=Math.round(d-(c/2));if(h+c>f){this.fileList.scrollTop=f-c}else{this.fileList.scrollTop=h}}}}else{this.fileList.innerHTML='<div style="padding:3px">To add items to your folder, please click <b>New Folder</b> or <b>New File</b> below.</div>'}if(b.fileManager){this.createButton.disabled=false;if($("hidden_iframe")){this.uploadButton.disabled=false}else{this.uploadButton.disabled=true}}else{this.createButton.disabled=true;this.uploadButton.disabled=true}},showUploadDialog:function(){var a=document.createElement("div");a.className="prompt";a.style.position="absolute";a.onkeypress=function(l){if(l.stopPropagation){l.stopPropagation()}else{l.cancelBubble=true}}.bindAsEventListener(this);var b=$("hidden_iframe");var d=function(l){var m=b.contentWindow.document.body.innerHTML;if(a.parentNode){Element.remove(a)}if(m&&m!=""){alert(m)}else{this.refresh(this.currentDirectory.path)}}.bindAsEventListener(this);b.onload=d;var f=document.createElement("form");f.target=b.name;f.action=this.currentDirectory.fileManager;f.method="post";f.enctype="multipart/form-data";var c=document.createElement("input");c.type="hidden";c.name="a";c.value="upload";f.appendChild(c);c=document.createElement("input");c.type="hidden";c.name="p";c.value=(this.currentDirectory.path||"");f.appendChild(c);if(/MSIE/.test(navigator.userAgent)){f.encoding="multipart/form-data";f.onsubmit=function(l){var n;var m=function(){try{var o=b.contentWindow.document.readyState;if(o=="complete"){clearInterval(n);d()}}catch(p){}};n=setInterval(m,10)}.bindAsEventListener(this)}var i=document.createElement("table");var k=i.insertRow(0);var g=k.insertCell(0);g.colSpan=2;g.innerHTML="<b>Upload File</b>";k=i.insertRow(1);g=k.insertCell(0);g.innerHTML="File";g=k.insertCell(1);var e=document.createElement("input");e.type="file";e.name="i";e.style.width="200px";g.appendChild(e);k=i.insertRow(2);g=k.insertCell(0);g.innerHTML="New filename";g=k.insertCell(1);var e=document.createElement("input");e.type="text";e.name="n";e.style.width="200px";g.appendChild(e);var j=document.createElement("input");j.type="submit";j.value="Upload";j.style.marginRight="5px";var h=document.createElement("input");h.type="button";h.value="Cancel";h.onclick=function(l){Element.remove(a);Event.stop(l)};k=i.insertRow(3);g=k.insertCell(0);g.innerHTML="&nbsp;";g=k.insertCell(1);g.appendChild(j);g.appendChild(h);f.appendChild(i);a.appendChild(f);this.element.appendChild(a);this.prompt=a;a.style.top=Math.round((this.element.offsetHeight-a.offsetHeight)/2)+"px";a.style.left=Math.round((this.element.offsetWidth-a.offsetWidth)/2)+"px";Form.focusFirstElement(f)},showDeleteDialog:function(){var c=this.selectedFile.type=="directory"?"Are you sure you want to PERMANENTLY delete this folder\nand all files and folders in it?":"Are you sure you want to PERMANENTLY delete this file?";if(this.selectedFile&&confirm(c)){var b=this.currentDirectory.fileManager;var a={parameters:"a=delete&p="+(this.currentDirectory.path||"")+"&f="+this.selectedFile.name,onSuccess:function(d){this.refresh(this.currentDirectory.path)}.bindAsEventListener(this),onFailure:function(d){this.refresh(this.currentDirectory.path);alert(d.responseText)}.bindAsEventListener(this)};this.filePreview.innerHTML="";this.fileList.innerHTML="Loading file list...";new Ajax.Request(b,a)}},showDirectoryCreateDialog:function(){var a=prompt("Enter a folder name:","");if(a){this.createDirectory(a)}},createDirectory:function(c){var b=this.currentDirectory.fileManager;var a={parameters:"a=createdir&p="+(this.currentDirectory.path||"")+"&d="+c,onSuccess:this.createDirectorySuccessful.bind(this),onFailure:this.createDirectoryFailed.bind(this)};this.filePreview.innerHTML="";this.fileList.innerHTML="Loading file list...";new Ajax.Request(b,a)},createDirectorySuccessful:function(a){this.refresh(this.currentDirectory.path)},createDirectoryFailed:function(a){this.refresh(this.currentDirectory.path);alert(a.responseText)},showPreview:function(b){var c=document.createElement("img");var a=false;c.onload=function(i){if(!a){a=true;var k=c.width;var j=c.height;while(this.filePreview.firstChild){Element.remove(this.filePreview.firstChild)}var h=this.filePreview.offsetWidth-6;var g=this.filePreview.offsetHeight-6;var f=c.width/h;var d=c.height/g;if(f>1&&f>=d){c.width=Math.floor(c.width/f);c.height=Math.floor(c.height/f)}else{if(d>1){c.width=Math.floor(c.width/d);c.height=Math.floor(c.height/d)}}c.style.position="absolute";c.style.top=Math.round((g-c.height)/2)+"px";c.style.left=Math.round((h-c.width)/2)+"px";c.style.backgroundColor="#FFFFFF";c.border=1;this.filePreview.appendChild(c);if(this.options.previewListener){this.options.previewListener(k,j)}}}.bindAsEventListener(this);c.onerror=function(d){while(this.filePreview.firstChild){Element.remove(this.filePreview.firstChild)}if(this.options.previewListener){this.options.previewListener("","")}}.bindAsEventListener(this);c.src=b},createFileRow:function(b,d){var f=d.insertRow(d.rows.length);var a=f.insertCell(0);a.className="filerow";a.width=10;var c=document.createElement("img");c.src=this.options[(b.image||b.type)+"Image"];a.appendChild(c);a=f.insertCell(1);a.className="filerow";var g=document.createElement("div");g.style.overflow="hidden";g.innerHTML=b.name;a.appendChild(g);a=f.insertCell(2);a.className="filerow";a.align="right";if(b.size!==undefined){var e;if(b.type=="directory"){e=b.size+" items"}else{e=this.formatFileSize(b.size)}a.innerHTML="<nobr>"+e+"</nobr>"}else{a.innerHTML="&nbsp;"}f.onmousedown=this.fileSelectListener(b);if(b.type=="file"){f.ondblclick=this.fileOpenListener(b)}else{f.ondblclick=this.directoryOpenListener(b)}f.onselectstart=function(){return false};b.element=f;return f},formatFileSize:function(a){if(!a){a=0}if(a<1024){return a+" bytes"}else{if(a<1024*1024){return this.twoDecimals(a/1024)+" KB"}else{return this.twoDecimals(a/(1024*1024))+" MB"}}},twoDecimals:function(a){return Math.round(a*100)/100},fileSelectListener:function(a){return function(b){this.selectRow(a);return false}.bindAsEventListener(this)},directoryOpenListener:function(a){return function(b){this.refresh(a.path)}.bindAsEventListener(this)},fileOpenListener:function(a){return function(b){if(this.options.openListener){this.options.openListener(a)}}.bindAsEventListener(this)},keyPressListener:function(){return function(b){if(this.element.parentNode){switch(b.keyCode){case Event.KEY_DELETE:this.showDeleteDialog();break;case Event.KEY_RETURN:if(this.selectedFile.type=="file"){this.fileOpenListener(this.selectedFile)()}else{this.directoryOpenListener(this.selectedFile)()}break;case Event.KEY_UP:var a=this.selectedIndex()-1;if(a<0){a=0}this.selectRow(this.entries[a]);break;case Event.KEY_DOWN:var a=this.selectedIndex()+1;if(a>=this.entries.length){a=this.entries.length-1}this.selectRow(this.entries[a]);break;case 33:var c=Math.floor(this.fileList.offsetHeight/this.entries[0].element.offsetHeight);var a=this.selectedIndex()-c;if(a<0){a=0}this.selectRow(this.entries[a]);break;case 34:var c=Math.floor(this.fileList.offsetHeight/this.entries[0].element.offsetHeight);var a=this.selectedIndex()+c;if(a>=this.entries.length){a=this.entries.length-1}this.selectRow(this.entries[a]);break;case 35:if(this.entries){this.selectRow(this.entries[this.entries.length-1])}break;case 36:if(this.entries){this.selectRow(this.entries[0])}break;default:return}Event.stop(b)}}.bindAsEventListener(this)},selectRow:function(a){if(this.selectedFile!=a){if(this.selectedFile){Element.removeClassName(this.selectedFile.element,"selected")}this.selectedFile=a;Element.addClassName(a.element,"selected");if(a.url){this.showPreview(a.url);if(this.options.standalone){this.fileLocation.value=a.url}if(this.options.selectListener){this.options.selectListener(a.url)}}else{this.showPreview("");if(this.options.selectListener){this.options.selectListener("")}}}if(a.element.offsetTop<this.fileList.scrollTop){this.fileList.scrollTop=a.element.offsetTop}else{if(a.element.offsetTop+a.element.offsetHeight>this.fileList.scrollTop+this.fileList.offsetHeight){this.fileList.scrollTop=(a.element.offsetTop+a.element.offsetHeight)-this.fileList.offsetHeight}}},selectedIndex:function(){for(index=0;index<this.entries.length;++index){if(this.entries[index]==this.selectedFile){return index}}return -1}};if(typeof Protoplasm!="undefined"){Protoplasm.register("filechooser",Control.FileChooser)};